<!doctype html>
<html lang="en">

<head>
    <title>Title</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Bootstrap CSS v5.2.1 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <link rel="stylesheet" rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./js/leaflet-1.9.4/leaflet.css">
    <link rel="stylesheet" href="./js/leaflet-routing-machine-3.2.12/dist/leaflet-routing-machine.css">
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&callback=initMap"></script>
</head>

<body>
    <header>
        <!-- place navbar here -->
    </header>
    <main>
        <div class="row ">
            <div class="col-md-6">
                <div class="map" id="map"></div>
                <div id="latlng">
                    <ul>
                        <li><b>latitude:</b> <span id="lat"></span></li>
                        <li><b>longitude:</b> <span id="lng"></span></li>
                        <li><b>Display Name:</b> <span id="dispname"></span></li>
                        <li><b>Geocode Result:</b> <span id="geores"></span></li>
                    </ul>
                </div>
            </div>

            <div class="col-md-6">
                <div class="input-group mb-3">
                    <input type="text" id="search-input" class="form-control" placeholder="Search Location">
                    <div class="input-group-append" style="border-radius: 0;">
                        <input name="" onclick="SearchLocation()" class="btn btn-primary" type="button"
                            value="Search" />
                    </div>
                </div>
                <div id="result" style="padding: 10px;">
                </div>
            </div>
        </div>
    </main>
    <footer>
        <!-- place footer here -->
    </footer>
    <!-- Bootstrap JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
        crossorigin="anonymous"></script>
    <!-- Leaflet js -->
    <script src="./js/leaflet-1.9.4/leaflet.js"></script>
    <script src="./js/leaflet-routing-machine-3.2.12/dist/leaflet-routing-machine.js"></script>
    <!-- jaquery -->
    <script src="./js/jquery-3.7.1/jquery-3.7.1.min.js"></script>


    <!-- primary -->
    <script src="./js/index.js"></script>

    <script>
        const loc = {
            lat: -6.223899606600648,
            lng: 106.808578396754,
        }

        const dest = {
            lat: -6.299451985856301,
            lng: 107.15323289675455
        }
        const zoom = 15;
        let map;
        let marker;
        let routingControl = null; // Initialize routingControl
        let waypoints = []; // Initialize waypoints array


        $(document).ready(function () {
            // Initialize the map using the global initMap function
            map = window.initMap('map', loc, {
                maxZoom: zoom,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            });

            // Initial MapRouting call without hardcoded waypoints
            routingControl = MapRouting(map, {
                // waypoints: [], // Start with no waypoints or remove this line
                routeWhileDragging: true,
                fitSelectedRoutes: true
            });

            map.on("click", function (e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;

                if (waypoints.length < 2) {
                    waypoints.push(L.latLng(lat, lng));
                    L.marker([lat, lng]).addTo(map).bindPopup(waypoints.length === 1 ? 'Start' : 'End').openPopup();
                }

                if (waypoints.length === 2) {
                    if (routingControl) {
                        routingControl.setWaypoints(waypoints);
                    } else {
                        routingControl = MapRouting(map, {
                            waypoints: waypoints,
                            routeWhileDragging: true,
                            fitSelectedRoutes: true
                        });
                    }
                    // Consider clearing waypoints for a new route:
                    // waypoints = [];
                    // Or allow modifying by removing this line and letting users click again
                }

                // Keep reverse geocoding for the clicked point
                ReverseGeocode(lat, lng).then((res) => {
                    $('#lat').html(lat);
                    $('#lng').html(lng);
                    $('#dispname').html(res.display_name);
                    // $('#geores').html(JSON.stringify(res)); // Simplified output
                });
            });

            // Remove the old single marker logic if not needed, or adapt it.
            // For now, we'll keep the main marker for other potential uses,
            // but routing waypoints will have their own markers.
            marker = initMarker(loc.lat, loc.lng, map);
            marker.on('dragend', async function (e) {
                const p = e.target.getLatLng();
                ReverseGeocode(p.lat, p.lng).then((res) => {
                    $('#lat').html(p.lat);
                    $('#lng').html(p.lng);
                    $('#dispname').html(res.display_name);
                    // $('#geores').html(JSON.stringify(res));
                });
            });
        });


        const sv = $('#search-input')
        sv.keydown(function (e) {
            setTimeout(() => {
                if (e.key === "Enter") {
                    SearchLocation();
                }
            }, 1000);
        });

        let debounceTimeout = null;
        sv.on('input', function (e) {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                const query = sv.val();
                if (query.length > 2) {
                    SearchLocation(query);
                }
            }, 1000); // 500ms debounce
        });

        /* Hit Nominatim API */
        const SearchLocation = async () => {
            const el_res = $('#result');

            const sv = $('#search-input').val();
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(sv)}`;

            const response = await fetch(url, {
                headers: {
                    'User-Agent': 'FATools/1.0 (galang.izqd@gmail.com)'
                }
            });

            const data = await response.json();

            let result = ``;
            if (data.length > 0) {
                data.forEach(x => {
                    result += `
                        <div class="card-hover selector" data-id="${x.place_id}"" data-lat="${x.lat}" data-lng="${x.lon}">
                            ${x.display_name}
                        </div>
                    `;
                });
                el_res.html(result);

                $(".selector").on("click", function () {
                    const lat = $(this).data('lat');
                    const lng = $(this).data('lng');

                    if (waypoints.length < 2) {
                        waypoints.push(L.latLng(lat, lng));
                        L.marker([lat, lng]).addTo(map).bindPopup(waypoints.length === 1 ? 'Start' : 'End').openPopup();
                        map.setView([lat, lng], zoom);
                    }

                    if (waypoints.length === 2) {
                        if (routingControl) {
                            routingControl.setWaypoints(waypoints);
                        } else {
                            routingControl = MapRouting(map, {
                                waypoints: waypoints,
                                routeWhileDragging: true,
                                fitSelectedRoutes: true
                            });
                        }
                        // Optionally clear waypoints: waypoints = [];
                    }
                    // Reverse geocode for the selected location
                    ReverseGeocode(lat, lng).then((res) => {
                        $('#lat').html(lat);
                        $('#lng').html(lng);
                        $('#dispname').html(res.display_name);
                        // $('#geores').html(JSON.stringify(res));
                    });
                });
            } else {
                el_res.html('No Result');
            }
        }
    </script>
</body>

</html>